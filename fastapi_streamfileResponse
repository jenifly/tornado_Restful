import typing

from io import BytesIO

import pandas as pd

from fastapi import FastAPI
from uvicorn import run
from starlette.responses import Response
from mimetypes import guess_type


app = FastAPI()


class DataFrameResponse(Response):
    def __init__(
        self,
        dataframe: typing.Any,
        filename: str,
    ) -> None:
        self.status_code = 200
        self.media_type = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        outfile = BytesIO()
        dataframe.to_excel(outfile, index=False)
        self.body = outfile.getvalue()
        outfile.close()
        self.init_headers({"Content-Disposition": f"attachment;fileName={filename}"})
        self.background = None


@app.get('/test')
def test():
    a = pd.DataFrame({'id':[1,2,3,4,5,6],'name':['Alice','Bob','Cindy','Eric','Helen','Grace '],'math':[90,89,99,78,97,93],'english':[89,94,80,94,94,90]})
    return DataFrameResponse(a, 'test.xlsx')


if __name__ == "__main__":
    run('main:app', port=80, reload=True, workers=1)
